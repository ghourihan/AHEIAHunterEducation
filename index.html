<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunter Education Practice Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* Custom font and base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f1; /* Light Teal Background */
        }
        .container {
            max-width: 420px; /* Mobile-first width */
            padding: 1rem;
        }
        /* Custom styles for engaging buttons */
        .answer-button {
            transition: all 0.15s ease-in-out;
            transform: scale(1);
        }
        .answer-button:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .correct {
            background-color: #10b981 !important; /* Emerald 500 */
            color: white !important;
            border-color: #059669 !important;
            animation: pulse-correct 0.5s 1;
        }
        .incorrect {
            background-color: #ef4444 !important; /* Red 500 */
            color: white !important;
            border-color: #dc2626 !important;
            animation: shake-incorrect 0.5s 1;
        }
        @keyframes pulse-correct {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        @keyframes shake-incorrect {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }

        }
        /* Style for the feedback message box (modal replacement) */
        #feedback-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 50;
            visibility: hidden; /* Fix: Removed double space */
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out, visibility 0.3s;
        }
        #feedback-message.show {
            transform: translate(-50%, -50%) scale(1);
            visibility: visible;
            opacity: 1;
        }
        /* Progress Bar Styles */
        #progress-bar-container {
            background-color: #cbd5e1;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
            width: 100%;
            margin-top: 4px;
        }
        #progress-bar {
            background-color: #22c55e;
            height: 100%;
            width: 0%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        /* Style for centered milestone message */
        .milestone-text {
            text-align: center;
            font-weight: bold;
            margin-top: 0.5rem;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Fix: Removed double space */
        }
        /* Ensure feedback text wraps */
        #feedback-text {
            overflow-wrap: break-word;
            word-wrap: break-word; /* legacy */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="quiz-app" class="container bg-white shadow-2xl rounded-xl border border-gray-100">

        <div id="launch-screen" class="p-8 text-center">
            <span data-lucide="shield" class="w-16 h-16 inline-block text-green-700 mb-4" aria-hidden="true"></span>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome, Future Hunter!</h1>
            <p class="text-md text-gray-600 mb-8">Choose your practice mode below to begin your Hunter Education review.</p>

            <div class="space-y-4">
                <button onclick="startRandomizedQuiz()" class="w-full py-3 bg-amber-600 text-white font-bold rounded-lg shadow-lg hover:bg-amber-700 transition-colors flex items-center justify-center">
                    <span data-lucide="shuffle" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                    Challenge Mode (Random Questions)
                </button>
                <button onclick="startSequentialQuiz()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-lg shadow-lg hover:bg-emerald-700 transition-colors flex items-center justify-center">
                    <span data-lucide="list-ordered" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                    Study Mode (Questions in Order)
                </button>
            </div>
            <p id="tip-display" class="text-sm text-gray-500 mt-6 italic"></p>
        </div>

        <div id="quiz-view" class="hidden">
            <header class="p-4 bg-green-700 text-white rounded-t-xl text-center">
                <div class="flex items-center justify-center mb-1">
                    <span data-lucide="shield-check" class="w-7 h-7 mr-2" aria-hidden="true"></span>
                    <h1 class="text-2xl font-bold tracking-tight">Hunter Education Practice Quiz</h1>
                </div>
                <p class="text-xs opacity-90">AHEIA Hunter Education</p>
            </header>

            <div class="flex justify-between items-center p-3 bg-green-50 rounded-b-lg border-b border-green-200">
                <span id="score-display" class="text-md font-semibold text-green-800 flex items-center" aria-live="polite">
                    <span data-lucide="medal" class="w-4 h-4 mr-1 text-yellow-600 fill-yellow-400" aria-hidden="true"></span> Score: 0
                </span>
                 <div class="flex-grow ml-4">
                    <span id="progress-display" class="text-xs font-medium text-gray-600 block text-right">
                        Question 1 / 55
                    </span>
                    <div id="progress-bar-container">
                        <div id="progress-bar"></div>
                    </div>
                </div>
            </div>

             <main id="game-container" class="p-3" aria-live="polite">
                 <div class="flex items-center mb-2 text-green-700">
                    <span id="category-icon" data-lucide="shield" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                    <span id="category-name" class="text-md font-semibold">Safety</span>
                </div>
                 <h2 id="question-text" class="text-lg font-bold mb-3 text-gray-800 leading-relaxed">
                    Loading question...
                </h2>
                 <div id="answer-buttons" class="space-y-2">
                    </div>
                 <button id="next-button"
                        class="mt-3 w-full py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors opacity-50 cursor-not-allowed"
                        onclick="nextQuestion()"
                        disabled
                        aria-disabled="true">
                    Next Question
                    <span data-lucide="arrow-right" class="w-5 h-5 inline ml-2" aria-hidden="true"></span>
                </button>

                 <button id="return-launch-quiz"
                        class="mt-2 w-full py-1.5 bg-green-700 text-white text-sm font-medium rounded-lg shadow-md hover:bg-green-800 transition-colors flex items-center justify-center"
                        onclick="goBackToLaunch()">
                    <span data-lucide="home" class="w-4 h-4 mr-1" aria-hidden="true"></span>
                    Return to Launch Screen
                </button>
            </main>

            <div id="end-screen" class="hidden p-8 text-center">
                <span id="rank-icon" data-lucide="trophy" class="w-16 h-16 mx-auto mb-4 text-yellow-500 fill-yellow-300" aria-hidden="true"></span>
                <h3 id="rank-title" class="text-2xl font-extrabold text-green-700 mb-3">Quiz Complete!</h3>
                <p id="final-score" class="text-3xl font-bold mb-2 text-gray-800">You scored 0/55!</p>
                <p id="high-score-display" class="text-md font-semibold text-gray-700 mb-4"></p>
                <p id="final-message" class="text-lg mb-8 text-gray-600"></p>
                <div class="space-y-4">
                    <button id="review-button" onclick="reviewWrongAnswers()"
                            class="w-full py-3 bg-yellow-600 text-white font-bold rounded-lg shadow-lg hover:bg-yellow-700 transition-colors flex items-center justify-center disabled:opacity-50"
                            disabled>
                        <span data-lucide="book-open-check" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                        Review Wrong Answers (<span id="wrong-count">0</span>)
                    </button>
                    <button onclick="goBackToLaunch()"
                            class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                        <span data-lucide="home" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                        Return to Launch Screen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="feedback-message" role="alert" class="p-4 rounded-xl shadow-2xl transition-all border-4 border-white backdrop-blur-sm" aria-live="polite">
        <div class="flex items-center justify-center">
            <span id="feedback-icon" class="text-4xl mr-3" aria-hidden="true"></span>
            <span id="feedback-text" class="text-xl font-bold text-white"></span>
        </div>
    </div>

    <script>
        // --- QUIZ DATA (55 Questions Total) ---
        const masterQuestions = [
            // ====================================================================================
            // SECTION 1: FIREARM & ARCHERY SAFETY (21 QUESTIONS)
            // ====================================================================================
             { question: "According to the Four Rules of Firearm Safety, where should the muzzle of a firearm ALWAYS be pointed?", answers: [ { text: "In a safe direction, away from people and pets, at all times.", isCorrect: true, explanation: "This is Rule #1. A safe direction is one where an accidental shot will not cause harm." }, { text: "At the ground or the sky.", isCorrect: false, explanation: "Pointing up or down is safer than pointing at someone, but it's not the *best* safe direction." }, { text: "Towards your hunting buddy.", isCorrect: false, explanation: "Never point a firearm at anything you don't intend to shoot, especially a person!" }, { text: "Towards the target only.", isCorrect: false, explanation: "You must always control the muzzle, even before you have identified your target." }, ], category: "Safety" },
             { question: "The second safety rule requires you to 'Treat every firearm as if it were loaded.' What must you always do when handed a firearm?", answers: [ { text: "Assume it is unloaded since the person handing it to you checked it.", isCorrect: false, explanation: "Never assume! Always check it yourself, every time you handle it." }, { text: "Always check the action yourself to be certain it is empty.", isCorrect: true, explanation: "That's right! You must always **PROVE** it safe yourself (Point, Remove, Observe, Verify, Engage)." }, { text: "Keep the safety in the 'off' position.", isCorrect: false, explanation: "The safety should be 'on' until you are ready to shoot." }, { text: "Hand it to your friend without checking.", isCorrect: false, explanation: "Safety is your personal responsibility. Never pass a gun without checking it first." }, ], category: "Safety" },
             { question: "When are you allowed to put your finger inside the trigger guard?", answers: [ { text: "Only when you have identified your target and are ready to shoot.", isCorrect: true, explanation: "This is Rule #4. Finger off the trigger until the moment you are certain to fire." }, { text: "Any time you are carrying the firearm.", isCorrect: false, explanation: "Keep your finger OUTSIDE the guard for maximum safety, especially when carrying." }, { text: "When you are unloading the firearm.", isCorrect: false, explanation: "Your finger should be off the trigger when loading or unloading." }, { text: "Only if the safety mechanism is on.", isCorrect: false, explanation: "Safeties can fail! Keep your finger away until ready to shoot." }, ], category: "Safety" },
             { question: "The third safety rule is to 'Be certain of your target and what is beyond it.' This means you must:", answers: [ { text: "Identify the animal legally and ensure your bullet has a safe backstop.", isCorrect: true, explanation: "Exactly! You must know what you're shooting at and ensure your bullet won't travel far if you miss or pass through." }, { text: "Only shoot at targets that are standing still.", isCorrect: false, explanation: "While safer, this isn't the main focus of the rule." }, { text: "Only shoot when you have a clear view for three miles.", isCorrect: false, explanation: "The safe backstop is the key, not just distance." }, { text: "Ask an adult to confirm the target is safe.", isCorrect: false, explanation: "While helpful, the responsibility is always on the person pulling the trigger." }, ], category:"Safety" },
             { question: "In the firearm safety acronym PROVE (Point, Remove, Observe, Verify, Engage), what does the 'V' stand for?", answers: [ { text: "View the barrel for obstruction", isCorrect: false, explanation: "Checking for obstruction is part of 'O' (Observe)." }, { text: "Verify the feed path is clear", isCorrect: true, explanation: "Correct. 'V' stands for Verify the feed path is clear, ensuring no hidden ammunition remains in the magazine or feed system." }, { text: "Value the target", isCorrect: false, explanation: "This is covered by the 3rd rule of safety (Be Certain of your Target)." }, { text: "Vary the ammunition type", isCorrect: false, explanation: "You should never vary the ammunition type." }, ], category: "Safety" },
             { question: "In the firearm safety acronym PROVE, what does the 'R' stand for?", answers: [ { text: "Ready your firearm", isCorrect: false, explanation: "Readying the firearm is part of 'E' (Engage)." }, { text: "Remove all ammunition", isCorrect: true, explanation: "Correct. 'R' means Remove all ammunition (magazine, chamber, feed path)." }, { text: "Release the safety", isCorrect: false, explanation: "The safety is engaged later." }, { text: "Rotate the bolt", isCorrect: false, explanation: "The bolt is rotated in the 'O' and 'V' stages." }, ], category: "Safety" },
             { question: "When walking beside another hunter, the safest muzzle direction is:", answers: [ { text: "Pointed directly forward", isCorrect: false, explanation: "Pointing forward risks pointing at the person in front or what is in front of them." }, { text: "Pointed at the ground near your feet", isCorrect: false, explanation: "Pointing too close to the ground risks a ricochet." }, { text: "Pointed away from your partner and toward the ground", isCorrect: true, explanation: "The muzzle should always be pointed in a safe direction, away from people, typically angled toward the ground on the outside of the group." }, { text: "Over-the-shoulder carry toward a partner", isCorrect: false, explanation: "Never point the muzzle toward anyone." }, ], category: "Safety" },
             { question: "What is the correct way to transport a firearm in a vehicle?", answers: [ { text: "Unloaded and encased, with ammunition stored separately", isCorrect: true, explanation: "Firearms must be unloaded and safely stored (encased) when in or on a vehicle, with ammunition stored separately, per Alberta law." }, { text: "Loaded but on safe", isCorrect: false, explanation: "Loaded firearms are never permitted in vehicles." }, { text: "Across the dashboard", isCorrect: false, explanation: "The firearm must be encased and not readily accessible." }, { text: "With bolt open and a round in the chamber", isCorrect: false, explanation: "A round in the chamber means the firearm is loaded." }, ], category: "Safety" },
             { question: "The correct way to cross a fence with a firearm is to:", answers: [ { text: "Pass it under or over the fence, muzzle controlled and unloaded", isCorrect: true, explanation: "Always unload first, open the action, control the muzzle (muzzle point must be away from you and your partners), and then cross safely." }, { text: "Keep it slung over your shoulder while crossing", isCorrect: false, explanation: "This compromises the muzzle direction and your balance." }, { text: "Jump quickly to avoid damage", isCorrect: false, explanation: "Never jump or rush when crossing obstacles with a firearm." }, { text: "Climb over with one hand holding the gun", isCorrect: false, explanation: "You must use both hands for climbing and maintain three points of contact." }, ], category: "Safety" },
             { question: "Under what condition is it safe and legal to lean a firearm against a vehicle?", answers: [ { text: "It is always safe as long as the safety is on.", isCorrect: false, explanation: "The safety can fail, and leaning the firearm risks a fall and accidental discharge." }, { text: "If the firearm is unloaded, action is open, and it is in a safe direction.", isCorrect: true, explanation: "Correct. While generally discouraged, if absolutely necessary for a brief moment, it must be unloaded, action open, and pointed in a safe direction." }, { text: "Only if you are using the vehicle as a rest for a steady shot.", isCorrect: false, explanation: "Shooting from or across a vehicle is usually illegal." }, { text: "Never; a firearm should always be encased in or on the vehicle.", isCorrect: false, explanation: "While best practice, the rules allow for brief uncased use outside the vehicle under certain conditions." }, ], category: "Safety" },
             { question: "When storing firearms at home, what is the most important legal requirement for ammunition?", answers: [ { text: "It must be kept in the same safe as the firearms.", isCorrect: false, explanation: "It must be locked up, but not necessarily in the same safe." }, { text: "It must be stored in the original manufacturer's box.", isCorrect: false, explanation: "Keeping it organized is good, but not legally required." }, { text: "It must be stored separately from the firearms and securely locked away.", isCorrect: true, explanation: "Correct. Both firearms and ammunition must be stored securely, and ammunition must be separated from the firearms." }, { text: "It must be stored in a cool, dry place.", isCorrect: false, explanation: "This is a practical tip, not the legal requirement." }, ], category: "Safety" },
             { question: "What is the single most important safety check a hunter must perform before loading a rifle?", answers: [ { text: "Make sure the barrel is free of obstructions.", isCorrect: false, explanation: "This is crucial, but checking the ammunition caliber is the primary safety concern for loading." }, { text: "Make sure the magazine is full of cartridges.", isCorrect: false, explanation: "The magazine doesn't need to be full." }, { text: "Check that the caliber/gauge of the ammunition exactly matches the caliber stamped on the firearm barrel.", isCorrect: true, explanation: "Correct. Using the wrong ammunition can destroy the firearm and cause severe injury." }, { text: "Make sure the telescopic sight is removed from the rifle.", isCorrect: false, explanation: "Scopes are meant to be used on the rifle." }, ], category: "Safety" },
             { question: "Which of the following is an example of ammunition designed to be used with a muzzleloading firearm?", answers: [ { text: "A modern metallic cartridge (e.g., .30-06)", isCorrect: false, explanation: "Metallic cartridges are used in modern breech-loading rifles, not muzzleloaders." }, { text: "Black powder and a projectile (e.g., patched round ball)", isCorrect: true, explanation: "Muzzleloaders use individual components—powder, a patch, and a projectile—loaded separately from the muzzle." }, { text: "A shotgun slug", isCorrect: false, explanation: "A slug is part of a shotgun shell." }, { text: "A rimfire cartridge (e.g., .22 LR)", isCorrect: false, explanation: "Rimfire cartridges are for modern rifles." }, ], category: "Safety" },
             { question: "What is the primary function of the action on a firearm?", answers: [ { text: "To reduce the recoil felt by the shooter.", isCorrect: false, explanation: "The stock and muzzle brake help with recoil, not the action." }, { text: "To hold the firearm firmly to the shooter's shoulder.", isCorrect: false, explanation: "That is the job of the stock." }, { text: "To load, fire, and eject a cartridge/shell.", isCorrect: true, explanation: "The action is the mechanical assembly that performs the essential functions of cycling the ammunition." }, { text: "To help the hunter aim through magnification.", isCorrect: false, explanation: "That is the job of the scope or sights." }, ], category: "Safety" },
             { question: "The stock of a firearm is designed to:", answers: [ { text: "Store extra ammunition", isCorrect: false, explanation: "The stock does not store ammunition." }, { text: "Absorb recoil and provide a stable shooting platform", isCorrect: true, explanation: "The stock stabilizes the firearm and helps manage recoil safely and comfortably." }, { text: "Fire the cartridge", isCorrect: false, explanation: "The firing pin and trigger mechanism fire the cartridge." }, { text: "Reduce sound", isCorrect: false, explanation: "A sound moderator reduces sound." }, ], category: "Safety" },
             { question: "What is the function of a shotgun choke?", answers: [ { text: "To prevent the barrel from overheating.", isCorrect: false, explanation: "The barrel dissipates heat, the choke does not." }, { text: "To adjust the spread (pattern) of the shot pellets.", isCorrect: true, explanation: "Correct. The choke is a constriction at the end of the barrel that determines how tightly the shot pattern holds together over distance." }, { text: "To increase the velocity of the pellets.", isCorrect: false, explanation: "Velocity is determined by the load in the shell." },
             { text: "To cycle the action automatically.", isCorrect: false, explanation: "The action cycles the shells." }
             ], category: "Safety" },
             { question: "Why is visibility especially important during dawn and dusk hunting hours?", answers: [ { text: "Animals are easier to see in low light", isCorrect: false, explanation: "Animals are harder to see clearly in low light." }, { text: "The human eye misjudges shapes and colors, increasing accident risk", isCorrect: true, explanation: "Low light causes visual distortion (often leading to mistaken identity); wearing bright visible clothing reduces this risk." }, { text: "It keeps game animals calm", isCorrect: false, explanation: "Visibility has no effect on game calmness." }, { text: "Blaze orange glows in the dark", isCorrect: false, explanation: "Blaze orange does not glow in the dark." }, ], category: "Safety" },
             { question: "Which of the following arrow points is predominantly used for target practice and small game?", answers: [ { text: "Broadhead", isCorrect: false, explanation: "Broadheads are sharp, multi-bladed points used only for big game hunting." }, { text: "Target or Field Point", isCorrect: true, explanation: "Correct. These points are conical and small, ideal for practice and minimizing damage to targets." },
             { text: "Judo Point", isCorrect: false, explanation: "Judo points are designed to prevent the arrow from getting lost in grass, often used for small game/stumping." },
             { text: "Blunt Point", isCorrect: false, explanation: "Blunt points are used for small game only, relying on kinetic shock." }, ], category: "Safety" },
             { question: "What is the purpose of the fletching (vanes/feathers) on an arrow?", answers: [ { text: "Gives the bow more potential energy.", isCorrect: false, explanation: "The bow itself holds the energy." }, { text: "Stabilizes the arrow while in flight.", isCorrect: true, explanation: "The fletching catches the air and guides the arrow, causing it to spin slightly for stability, like a spin on a football." }, { text: "Reduces friction when firing the arrow.", isCorrect: false, explanation: "Fletching *increases* drag, but this is necessary for stabilization." }, { text: "Makes the arrow easier to find down range.", isCorrect: false, explanation: "While true, the primary purpose is stabilization." }, ], category: "Safety" },
             { question: "When should you attach your full-body safety harness to the tree?", answers: [ { text: "After sitting in the stand", isCorrect: false, explanation: "It's too late then! The safest rule is to be attached before your feet leave the ground." }, { text: "Before leaving the ground", isCorrect: true, explanation: "You should use a lifeline or safety rope system to be attached from the moment you start climbing until you are back on the ground." }, { text: "Only when hunting alone", isCorrect: false, explanation: "Safety harnesses must be worn by all hunters in elevated stands at all times." }, { text: "When hauling your firearm up", isCorrect: false, explanation: "You must be attached *before* you start hauling anything up." }, ], category: "Safety" },
             { question: "How should your firearms and equipment be brought into a treestand?", answers: [ { text: "Thrown up by someone still on the ground.", isCorrect: false, explanation: "This is highly dangerous and unethical." }, { text: "Using a haul line once having reached the top and secured a safety harness.", isCorrect: true, explanation: "Correct. The firearm must be unloaded and brought up using a haul line only after the hunter is safely secured in the stand." }, { text: "Carried up while climbing into the stand.", isCorrect: false, explanation: "Carrying a firearm or bow while climbing compromises the critical 'three points of contact' rule." }, { text: "Brought up while installing the treestand.", isCorrect: false, explanation: "Equipment should only be brought up when the hunter is ready to hunt, not during installation." }, ], category: "Safety" },
            // ====================================================================================
            // SECTION 2: ETHICS & LEGAL RESPONSIBILITY (NOW 10 QUESTIONS)
            // ====================================================================================
             { question: "What is legally required to hunt on private property in Alberta?", answers: [ { text: "Verbal permission from the landowner.", isCorrect: false, explanation: "Verbal permission is good, but **written** permission is often legally required and always preferred for proof." }, { text: "Written permission from the landowner or resident.", isCorrect: true, explanation: "Correct! To protect yourself and respect the owner, written permission is the correct legal standard." }, { text: "A phone call to Fish and Wildlife.", isCorrect: false, explanation: "You must deal directly with the property owner." }, { text: "Nothing, if the land is not posted.", isCorrect: false, explanation: "Hunting on private property always requires permission." }, ], category: "Ethics" },
             { question: "After harvesting a big game animal, the first legal requirement is to:", answers: [ { text: "Transport it immediately", isCorrect: false, explanation: "Tagging must happen before transport." }, { text: "Take photos for documentation", isCorrect: false, explanation: "This is optional." }, { text: "Properly affix and cut the tag before moving it", isCorrect: true, explanation: "In Alberta, you must immediately affix the tag to the carcass and cut the corresponding notches before moving the animal or field dressing it." }, { text: "Gut the animal first", isCorrect: false, explanation: "Tagging comes before field dressing." }, ], category: "Ethics" },
             { question: "Which of the following is the best description of field dressing a harvested animal?", answers: [ { text: "Preparing the animal to be mounted.", isCorrect: false, explanation: "This is done by a taxidermist later." }, { text: "Tagging the animal so it may be identified.", isCorrect: false, explanation: "Tagging is legally required, but it's a separate step." }, { text: "Adding seasoning to the meat to help preserve it.", isCorrect: false, explanation: "Preserving is done with cooling or processing." }, { text: "Removing the entrails from the body cavity to cool the meat.", isCorrect: true, explanation: "Correct. Field dressing immediately removes the internal organs to allow the meat to cool and prevent spoilage." }, ], category: "Ethics" },
             { question: "What is the definition of Fair Chase in hunting ethics?", answers: [ { text: "Using bait and motorized vehicles to track and shoot animals.", isCorrect: false, explanation: "This is generally considered *un*fair chase." }, { text: "Giving the game animal a reasonable chance to escape.", isCorrect: true, explanation: "Correct. Fair Chase is the ethical pursuit of game that does not put the hunter at an unfair advantage." }, { text: "Only hunting during open season and following legal bag limits.", isCorrect: false, explanation: "This is the legal minimum; fair chase is an ethical standard beyond law." }, { text: "Hunting only with a bow and arrow.", isCorrect: false, explanation: "Fair chase applies to all legal hunting methods." }, ], category: "Ethics" },
             { question: "Ethical hunters should always:", answers: [ { text: "Take a shot even if the animal is partially obscured", isCorrect: false, explanation: "Never take an obscured or risky shot that may lead to wounding loss." }, { text: "Only harvest animals they can recover", isCorrect: true, explanation: "Ethics require hunters to make every effort to recover and use what they harvest. This means knowing your limits and the environment." }, { text: "Use any method if the hunt is legal", isCorrect: false, explanation: "Ethics often go beyond what is legal. Fair chase is always required." }, { text: "Fire until the animal stops moving", isCorrect: false, explanation: "This is excessive and unethical. A shot must be aimed to dispatch the animal quickly and humanely." }, ], category: "Ethics" },
             { question: "If you observe illegal hunting or fishing activity (poaching), what should you do immediately?", answers: [ { text: "Confront the individual and tell them to stop.", isCorrect: false, explanation: "Never confront a suspected poacher; it can be dangerous." }, { text: "Discreetly collect as much detail as possible (license plate, location, description) and call the Report-A-Poacher line.", isCorrect: true, explanation: "Excellent! Your safety is first. Observe, don't confront, and report the details to the authorities." }, { text: "Wait until you get home and report it online later.", isCorrect: false, explanation: "Reporting immediately is crucial while details are fresh and the poacher is still present." }, { text: "Take a picture of the poacher and post it online.", isCorrect: false, explanation: "This compromises the investigation and can be dangerous." }, ], category: "Ethics" },
             
             { question: "If you take a shot and miss, what is the most responsible thing to do next?", answers: [ { text: "Immediately shoot again until you hit the animal", isCorrect: false, explanation: "This risks an unethical and unsafe shot." }, { text: "Stop, mark the spot, and check for any sign of impact or injury", isCorrect: true, explanation: "Correct. Even when you think you missed, always check for evidence of a hit (blood, hair, tracks) to ensure ethical recovery." }, { text: "Leave immediately to find another animal", isCorrect: false, explanation: "This violates the ethical obligation to recover game." }, { text: "Wait until the next day to look", isCorrect: false, explanation: "A suspected wound requires immediate investigation." }, ], category: "Ethics" },
             { question: "What should hunters and anglers do to help prevent the spread of invasive species?", answers: [ { text: "Rinse boats and gear with clean water and dry them before travel", isCorrect: true, explanation: "Correct. The 'Clean, Drain, Dry' motto is essential to prevent spreading invasive species like zebra mussels or whirling disease." }, { text: "Only clean equipment in lakes or rivers", isCorrect: false, explanation: "Cleaning in waterbodies is how invasive species are spread." }, { text:"Move baitfish between waterbodies", isCorrect: false, explanation: "This is illegal and a primary way invasive species spread." }, { text: "Release leftover live bait into the wild", isCorrect: false, explanation: "This can introduce non-native species or disease." }, ], category: "Ethics" },
             { question: "When visiting a shooting range, what is your primary ethical responsibility?", answers: [ { text: "To shoot as many targets as possible.", isCorrect: false, explanation: "Shooting volume is not the primary responsibility." }, { text: "To follow all safety commands and clean up your brass/shells.", isCorrect: true, explanation: "Correct. Following commands from the Range Safety Officer (RSO) and cleaning up trash are the primary duties for maintaining a safe and respectful environment." }, { text: "To only shoot when the range is totally empty.", isCorrect: false, explanation: "Ranges often have multiple users; safety rules guide shared space." }, { text: "To bring a large variety of different firearms to test.", isCorrect: false, explanation: "This is a personal goal, not an ethical responsibility." }, ], category: "Ethics" },
             { question: "What is the ethical responsibility of a hunter toward a landowner's fences and gates?", answers: [ { text: "Always leave gates open to prevent wear and tear.", isCorrect: false, explanation: "Leaving gates open can let livestock out." }, { text: "Cut fences that block your path for quicker movement.", isCorrect: false, explanation: "This is illegal and unethical destruction of property." }, { text: "Leave gates exactly as you found them (open if open, closed if closed).", isCorrect: true, explanation: "Correct. Respecting the landowner's property means leaving things as you found them to manage livestock and prevent damage." }, { text: "Only use gates clearly marked for public access.", isCorrect: false, explanation: "Private land access requires permission, regardless of posting." }, ], category: "Ethics" },
            // ====================================================================================
            // SECTION 3: SURVIVAL & FIRST AID (8 QUESTIONS)
            // ====================================================================================
             { question: "When lost in the wilderness, your first step should be to:", answers: [ { text: "Keep walking until you find a road", isCorrect: false, explanation: "Walking while stressed often leads to walking in circles." }, { text: "Fire three shots", isCorrect: false, explanation: "Signaling comes after planning." }, { text: "Sit down, calm yourself, and plan (S.T.O.P.)", isCorrect: true, explanation: "The **S.T.O.P.** principle (**S**top, **T**hink, **O**bserve, **P**lan) helps avoid panic and guides safe action." }, { text: "Build a shelter right away", isCorrect: false, explanation: "Planning must come before action." }, ], category: "Survival" },
             { question: "What is the best way to signal for help if you are lost or injured in an area where your phone doesn't work?", answers: [ { text: "Shouting as loud as you can until someone hears you.", isCorrect: false, explanation: "Shouting wastes energy quickly." }, { text: "Lighting a large, smoky signal fire, or using three signal shots/blasts.", isCorrect: true, explanation: "The international distress signal is **three** of anything (fires, whistle blasts, shots) repeated at regular intervals." }, { text: "Leaving a note attached to a tree.", isCorrect: false, explanation: "A note will likely not be found in time." }, { text: "Walking continuously in one direction until you find a road.", isCorrect: false, explanation: "This can lead you further into danger or exhaustion." }, ], category: "Survival" },
             { question: "What is the proper way to use a mirror or whistle for an emergency signal?", answers: [ { text: "Flash or sound the signal **three times** in quick succession, followed by a pause.", isCorrect: true, explanation: "Correct. The international distress signal is three flashes/blasts, followed by a break, then repeating the pattern." }, { text: "Hold the mirror steady for ten minutes or blow the whistle once loudly.", isCorrect: false, explanation: "Signals must be repeated in bursts." }, { text: "Use the mirror to look for smoke from a fire.", isCorrect: false, explanation: "The mirror is for signaling aircraft or distant searchers." }, { text: "Use the whistle to scare away animals.", isCorrect: false, explanation: "Whistles should be used for signaling human rescuers." }, ], category: "Survival" },
             { question: "When you approach an injured person in the woods, what is the first step in giving First Aid (according to the D.R.S.A.B.C.D. sequence)?", answers: [ { text: "Check for a pulse and breathing (B).", isCorrect: false, explanation: "This comes later. You must ensure safety first." }, { text: "Check the scene for Danger (D).", isCorrect: true, explanation: "Correct! **D**anger is always the first step. Never put yourself in danger to help another person." }, { text: "Call for help (S).", isCorrect: false, explanation: "This comes after checking the scene." }, { text: "Check for a response (R).", isCorrect: false, explanation: "This comes after checking the scene for danger." }, ], category: "Survival" },
             { question: "What is the most reliable method for purifying water from an unknown source in a wilderness survival situation?", answers: [ { text: "Running it through a clean cloth.", isCorrect: false, explanation: "Filtering only removes sediment; it doesn't kill bacteria or viruses." }, { text: "Boiling the water vigorously for at least one minute.", isCorrect: true, explanation: "Boiling is the most reliable method, as it kills virtually all pathogens (bacteria, viruses, and protozoa)." }, { text: "Adding salt or sugar to the water.", isCorrect: false, explanation: "This does nothing to purify it." }, { text: "Freezing it overnight.", isCorrect: false, explanation: "Freezing only slows bacteria growth; it doesn't purify." }, ], category: "Survival" },
             { question: "Which two tools are essential for navigation that work regardless of batteries or phone service?", answers: [ { text: "GPS and Satellite Phone", isCorrect: false, explanation: "These rely on batteries/service and are not reliable long-term." }, { text: "Map and Compass", isCorrect: true, explanation: "Correct. A map and compass are the fundamental survival tools for navigation that do not require power and should be carried on every trip." }, { text: "A whistle and a signal mirror", isCorrect: false, explanation: "These are signaling tools, not navigational tools." }, { text: "Trail markers and flares", isCorrect: false, explanation: "These are signaling tools." }, ], category: "Survival" },
             { question: "What is the most effective clothing strategy to prevent hypothermia?", answers: [ { text: "Wearing a single, thick, heavy coat.", isCorrect: false, explanation: "A single layer makes it hard to regulate temperature." }, { text: "Wearing several layers that can be adjusted to match activity and weather.", isCorrect: true, explanation: "Correct. Layering allows you to add or remove clothing to prevent sweating (which leads to cooling) and maintain a stable body temperature." }, { text: "Wearing only cotton clothing because it's breathable.", isCorrect: false, explanation: "Cotton retains moisture and causes rapid cooling (often called 'death cloth')." }, { text: "Wearing only a windbreaker.", isCorrect: false, explanation: "A windbreaker doesn't provide enough insulation." }, ], category: "Survival" },
             { question: "If a survival situation requires you to start a fire in damp conditions, what is the best natural material to use as tinder (fire starter)?", answers: [ { text: "Large, damp logs.", isCorrect: false, explanation: "Logs are used for fuel, not tinder, and dampness makes them useless for starting." }, { text: "Green moss or fresh grass.", isCorrect: false, explanation: "These are wet and will not ignite easily." }, { text: "Dried inner bark, bird nests, or dry cedar shavings.", isCorrect: true, explanation: "Correct. Tinder must be very fine and bone-dry to catch a spark, such as the inner bark of a dead tree or finely shaved wood." }, { text: "Pine cones.", isCorrect: false, explanation: "Pine cones are good kindling, but usually too dense to catch a spark easily." }, ], category: "Survival" },
            // ====================================================================================
            // SECTION 4: WILDLIFE IDENTIFICATION (10 QUESTIONS)
            // ====================================================================================
             { question: "Which of the following predatory animals typically has a more powerful build, broader head, and larger feet, making it distinct from a coyote?", answers: [ { text: "Fox", isCorrect: false, explanation: "Foxes are much smaller than both wolves and coyotes." }, { text: "Wolf", isCorrect: true, explanation: "Correct. Wolves are significantly larger, heavier, and have broader muzzles and larger feet than the slender coyote." },
             { text: "Coyote", isCorrect: false, explanation: "The coyote is smaller and more slender compared to the wolf." },
             { text: "Cougar", isCorrect: false, explanation: "Cougars are felines, not canines." }, ], category: "Wildlife ID" },
             { question: "Which physical feature is the clearest indicator to help distinguish a Grizzly Bear from a Black Bear?", answers: [ { text: "Coat color (Grizzlies are always brown)", isCorrect: false, explanation: "Black bears can also be brown, so color is unreliable." }, { text: "A pronounced shoulder hump and longer front claws.", isCorrect: true, explanation: "Correct. The large, muscular shoulder hump and long, straight claws are defining features of a Grizzly Bear." }, { text: "Black bears are much larger in size.", isCorrect: false, explanation: "Grizzlies are generally much larger and heavier." }, { text: "Grizzlies have long, pointed ears.", isCorrect: false, explanation: "Black bears typically have taller, more pointed ears." }, ], category: "Wildlife ID" },
             { question: "Which Alberta bird makes a “drumming” sound by beating its wings on a log during spring mating?", answers: [ { text: "Sharp-tailed Grouse", isCorrect: false, explanation: "Sharp-tailed Grouse perform an elaborate dancing display." }, { text: "Ruffed Grouse", isCorrect: true, explanation: "The male Ruffed Grouse makes a distinctive drumming sound to attract females and mark territory." }, { text: "Ptarmigan", isCorrect: false, explanation: "Ptarmigan are alpine birds that primarily make cackling or crowing calls." }, { text: "Spruce Grouse", isCorrect: false, explanation: "Spruce Grouse are quiet birds that rely on camouflage." }, ], category: "Wildlife ID" },
             { question: "Which of these animals is the largest member of the deer family (Cervidae)?", answers: [ { text: "Elk (Wapiti)", isCorrect: false, explanation: "Elk are large, but the Moose is significantly bigger." }, { text: "Moose", isCorrect: true, explanation: "The Moose is the largest species in the deer family, known for its massive size and palmate antlers." }, { text: "Caribou", isCorrect: false, explanation: "Caribou are smaller than both Moose and Elk." }, { text: "Mule Deer", isCorrect: false, explanation: "Mule Deer are the smallest of these four." }, ], category: "Wildlife ID" },
             { question: "Which deer species is known for flashing the bright white underside of its tail ('flagging') as it runs away?", answers: [ { text: "Mule Deer", isCorrect: false, explanation: "Mule deer have a smaller, black-tipped tail that they typically carry down." }, { text: "White-Tailed Deer", isCorrect: true, explanation: "That's right! The White-Tailed Deer lifts its bushy, white-underside tail as a warning signal when running." }, { text: "Moose", isCorrect: false, explanation: "Moose have a very small, dark tail." }, { text: "Elk (Wapiti)", isCorrect: false, explanation: "Elk have a pale rump patch but do not 'flag' their tail." }, ], category: "Wildlife ID" },
             { question: "Which large Alberta game animal is known for having huge, wide, paddle-shaped (palmate) antlers?", answers: [ { text: "Moose", isCorrect: true, explanation: "Correct! The Moose's massive, palmate antlers are its signature feature." }, { text: "Elk (Wapiti)", isCorrect: false, explanation: "Elk have long, branched antlers, not the wide paddle shape." }, { text: "Bighorn Sheep", isCorrect: false, explanation: "Bighorn Sheep have large, curled horns, not antlers." }, { text: "Caribou", isCorrect: false, explanation: "Caribou antlers are branched and complex, but not wide paddles like a Moose's." }, ], category: "Wildlife ID" },
             { question: "What unusual feature distinguishes Caribou from all other species of the deer family (Cervidae)?", answers: [ { text: "They are the only deer species that sheds their velvet annually.", isCorrect: false, explanation: "All deer species shed velvet annually." }, { text: "Both males and females typically grow antlers.", isCorrect: true, explanation: "Correct. Caribou (reindeer) are the only species in the deer family where both the male and the female typically grow antlers." }, { text: "They are the only species that lives below the timberline.", isCorrect: false, explanation: "All species mentioned live below the timberline at some point." },
             { text: "They only eat moss and lichens in the winter.", isCorrect: false, explanation: "Their diet is more diverse than just moss and lichens." },
             ], category: "Wildlife ID" },
             { question: "Which type of waterfowl usually dips its head and body underwater to feed, leaving its tail sticking up?", answers: [ { text: "Diving ducks (e.g., goldeneye, scaup)", isCorrect: false, explanation: "Diving ducks disappear completely underwater." }, { text: "Geese", isCorrect: false, explanation: "Geese typically graze on land or dabble near the surface." }, { text: "Dabbling ducks (e.g., Mallard, Pintail)", isCorrect: true, explanation: "Correct. Dabbling ducks feed by tipping their body forward, or 'dabbling,' in shallow water." }, { text: "Loons", isCorrect: false, explanation: "Loons are diving birds that hunt deep underwater." }, ],
             category: "Wildlife ID" },
             { question: "In Alberta, what distinguishes a lawful bull Moose from a cow Moose during a general hunting season?", answers: [ { text: "The bull must have antlers wider than 10 cm (4 inches).", isCorrect: false, explanation: "Antler width is a requirement for certain Elk or White-Tailed Deer hunts, but Moose regulations often use antler size and shape." }, { text: "The bull must have antlers with at least one branch point.", isCorrect: false, explanation: "This is a common feature but not the universal legal distinction for a bull Moose." }, { text: "The bull must have antlers with at least one visible brow tine, or a set of antlers of a defined minimum size.", isCorrect: true, explanation: "Correct. Legal definitions for a bull Moose often require a minimum antler width, number of points, or the presence of specific tines, depending on the Wildlife Management Unit (WMU)." }, { text: "The bull is always larger than the cow.", isCorrect: false, explanation: "Size is not a legal determinant." }, ], category: "Wildlife ID" },
             { question: "What is the key difference between a Mule Deer and a White-Tailed Deer when identifying them by their ears and tail?", answers: [ { text: "Mule Deer have smaller ears and flag a large white tail when running.", isCorrect: false, explanation: "White-Tailed Deer have the flagging white tail." }, { text: "White-Tailed Deer have large, mule-like ears and a small black-tipped tail.", isCorrect: false, explanation: "Mule Deer have the large ears and the black-tipped tail." }, { text: "Mule Deer have large, mule-like ears and a small black-tipped tail that is not flagged.", isCorrect: true, explanation: "Correct. The large ears and dark, rope-like tail distinguish the Mule Deer from the White-Tailed Deer's smaller ears and large, bushy white flag." }, { text: "They cannot be distinguished by tail or ears alone.", isCorrect: false, explanation: "These are the key distinguishing features." }, ], category: "Wildlife ID" },
            // ====================================================================================
            // SECTION 5: CONSERVATION & MANAGEMENT (6 QUESTIONS)
            // ====================================================================================
             { question: "The primary goal of wildlife management is to:", answers: [ { text: "Produce trophy animals for hunters", isCorrect: false, explanation: "This is a minor benefit, not the primary goal." }, { text: "Maintain healthy, balanced populations in their habitat", isCorrect: true, explanation: "Correct. Wildlife management ensures populations stay within the habitat’s carrying capacity and are healthy." }, { text: "Limit animal reproduction", isCorrect: false, explanation: "Management aims for balance, not just limits." }, { text: "Increase hunting license sales", isCorrect: false, explanation: "Sales fund management, but are not the goal itself." }, ], category: "Conservation" },
             { question: "What is the primary purpose of government-set bag limits and hunting seasons?", answers: [ { text: "To prevent hunters from spending too much time in the field.", isCorrect: false, explanation: "It's about the wildlife, not the hunters' time." }, { text: "To increase the cost of hunting licenses.", isCorrect: false, explanation: "This is a revenue method, not the primary biological purpose." }, { text: "To manage wildlife populations, prevent overharvesting, and maintain a healthy ecosystem balance.", isCorrect: true, explanation: "Correct! Bag limits ensure that harvest levels are sustainable and protect wildlife populations." }, { text: "To make wildlife reproduce faster.", isCorrect: false, explanation: "Limits manage the harvest, not the reproduction rate." }, ], category: "Conservation" },
             { question: "Carrying Capacity in wildlife management refers to:", answers: [ { text: "The maximum number of hunters an area can support.", isCorrect: false, explanation: "Carrying capacity refers to the animals, not the people." }, { text: "The maximum size of a single animal in a species.", isCorrect: false, explanation: "This is about population size, not physical size." }, { text: "The maximum number of animals of a species that a habitat can sustain indefinitely.", isCorrect: true, explanation: "That's the definition! It's the maximum sustainable population given the resources available in that area." }, { text: "The average weight of an adult deer.", isCorrect: false, explanation: "This is about population size, not weight." }, ], category: "Conservation" },
             { question: "How do hunters primarily contribute to wildlife conservation funding?", answers: [ { text: "By physically building wildlife habitats.", isCorrect: false, explanation: "Hunters sometimes do this, but it's not the primary financial contribution." }, { text: "Through the purchase of hunting licenses, tags, and excise taxes on equipment.", isCorrect: true, explanation: "Yes! License fees are the main source of funding for most wildlife management and conservation programs." }, { text: "By feeding wild animals in winter.", isCorrect: false, explanation: "Feeding wildlife is generally discouraged." },
             { text: "By lobbying the government for tax breaks.", isCorrect: false, explanation: "The money comes from purchases, not political lobbying." },
             ], category: "Conservation" },
             { question: "What does the term Wounding Loss refer to in hunting?", answers: [ { text: "The loss of money spent on hunting equipment.", isCorrect: false, explanation: "Wounding loss refers to the animal resource." }, { text: "An animal that is shot but escapes and is never recovered by the hunter.", isCorrect: true, explanation: "Correct. This is the tragic and unethical loss of a game animal that was killed but not found and utilized." }, { text: "The financial penalty for shooting the wrong species.", isCorrect: false, explanation: "That is a fine." }, { text: "The loss of meat during field dressing.", isCorrect: false, explanation: "This is normal meat wastage, not wounding loss." }, ], category: "Conservation" },
             { question: "Why is it important to record and report hunter observations (like wildlife sightings or track counts) to Fish and Wildlife?", answers: [ { text: "So the government can track successful hunters for taxes.", isCorrect: false, explanation: "This is not the purpose of wildlife reporting." }, { text: "To help researchers and biologists monitor animal health, movements, and population trends.", isCorrect: true, explanation: "Correct. Hunters provide invaluable ground-level data that informs wildlife management decisions." }, { text: "To prove you were in a specific area on a certain date.", isCorrect: false, explanation: "This is personal record-keeping, not the goal of the reporting program." }, { text: "To claim a reward for finding a rare animal.", isCorrect: false, explanation: "Reporting is a required contribution to conservation, not a reward program." }, ], category: "Conservation" }
        ];

        // --- GAME STATE ---
        const TOTAL_QUESTIONS = masterQuestions.length; // This is now 55
        let currentQuestionIndex = 0;
        let score = 0;
        let isAnswerLocked = false;
        let incorrectlyAnsweredIndices = [];
        let currentQuizSet;
        let lastCorrectAnswerIndex = -1;
        const HIGH_SCORE_KEY = 'hunterEdQuizHighScore';

        // --- Feedback Message Arrays ---
        const correctMessages = [
            "✅ Nailed it!", "✅ Awesome!", "✅ You got it!", "✅ Exactly right!", "✅ Great job!",
        ];
        const incorrectMessages = [
            "❌ Not quite!", "❌ Close, but try this:", "❌ That wasn't it. Here's the scoop:",
            "❌ Good try! The correct answer is:", "❌ Oops! Remember this:",
        ];

         // --- Hunting Tips Array ---
        const tips = [
            "Always point your firearm in a safe direction.", "Treat every firearm as if it were loaded.",
            "Be sure of your target and what's beyond it.", "Keep your finger off the trigger until ready to shoot.",
            "Always ask for permission before hunting on private land.", "Respect landowners and their property.",
            "Make every effort to recover harvested game.", "Know your firearm and ammunition.",
            "Practice marksmanship for clean, ethical shots.", "Wear blaze orange for visibility.",
            "Clean, Drain, and Dry your boat and gear to prevent invasive species.",
            "Report poachers using the Report-A-Poacher line.",
            "Always carry a map, compass, and know how to use them.",
            "Pack essential survival gear, even for short trips.",
            "Tell someone your hunting plan and when you expect to return."
        ];

        // --- DOM REFERENCES ---
        const questionText = document.getElementById('question-text');
        const answerButtonsContainer = document.getElementById('answer-buttons');
        const nextButton = document.getElementById('next-button');
        const scoreDisplay = document.getElementById('score-display');
        const progressDisplay = document.getElementById('progress-display');
        const gameContainer = document.getElementById('game-container');
        const endScreen = document.getElementById('end-screen');
        const finalScore = document.getElementById('final-score');
        const finalMessage = document.getElementById('final-message');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackText = document.getElementById('feedback-text');
        const feedbackIcon = document.getElementById('feedback-icon');
        const reviewButton = document.getElementById('review-button');
        const wrongCountSpan = document.getElementById('wrong-count');
        const categoryIcon = document.getElementById('category-icon');
        const categoryName = document.getElementById('category-name');
        const rankIcon = document.getElementById('rank-icon');
        const rankTitle = document.getElementById('rank-title');
        const launchScreen = document.getElementById('launch-screen');
        const quizView = document.getElementById('quiz-view');
        const progressBar = document.getElementById('progress-bar');
        const highScoreDisplay = document.getElementById('high-score-display');
        const tipDisplay = document.getElementById('tip-display');

        // --- HELPER FUNCTIONS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderIcons() {
            lucide.createIcons();
        }

        function getCategoryIcon(category) {
            switch(category) {
                case "Safety": return "shield";
                case "Ethics": return "gavel";
                case "Survival": return "tent";
                case "Wildlife ID": return "paw-print";
                case "Conservation": return "tree-pine";
                default: return "help-circle";
            }
        }

        function getCategoryDisplayName(category) {
            switch(category) {
                case "Safety": return "Firearm & Archery Safety";
                case "Ethics": return "Ethics & Legal Responsibility";
                case "Survival": return "Survival & First Aid";
                case "Wildlife ID": return "Wildlife Identification";
                case "Conservation": return "Conservation & Management";
                default: return "Unknown Topic";
            }
        }

        function showFeedback(explanation, type, milestoneMsg = "") {
            let feedbackPrefix = "";

            if (type === 'correct') {
                feedbackPrefix = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                feedbackMessage.style.backgroundColor = 'rgba(16, 185, 129, 0.9)';
                feedbackMessage.style.borderColor = 'white';
                feedbackIcon.innerHTML = '🎉';
            } else { // incorrect
                feedbackPrefix = incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)];
                feedbackMessage.style.backgroundColor = 'rgba(239, 68, 68, 0.9)';
                feedbackMessage.style.borderColor = 'white';
                feedbackIcon.innerHTML = '❌';
            }

            let htmlContent = `${feedbackPrefix} ${explanation}`.trim();
            if (milestoneMsg) {
                htmlContent += `<br><div class="milestone-text">${milestoneMsg}</div>`;
            }

            feedbackText.innerHTML = htmlContent;
            feedbackMessage.classList.add('show');
        }

        // --- UPDATED High Score Functions (Simplified saveHighScore) ---
        function getHighScore() {
            return parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0');
        }

        function saveHighScore(newScore) {
            const currentHighScore = getHighScore();
            if (newScore > currentHighScore) {
                localStorage.setItem(HIGH_SCORE_KEY, newScore.toString());
                return true;
            }
            return false;
        }

        // --- View Management ---
        function showView(viewName) {
            launchScreen.classList.add('hidden');
            quizView.classList.add('hidden');
            gameContainer.classList.add('hidden');
            endScreen.classList.add('hidden');

            if (viewName === 'launch') {
                launchScreen.classList.remove('hidden');
                const randomTip = tips[Math.floor(Math.random() * tips.length)];
                tipDisplay.textContent = `💡 Tip: ${randomTip}`;
            } else if (viewName === 'quiz') {
                quizView.classList.remove('hidden');
                gameContainer.classList.remove('hidden');
            } else if (viewName === 'end') {
                 quizView.classList.remove('hidden');
                 endScreen.classList.remove('hidden');
            }
             renderIcons();
        }

        // --- GAME LOGIC ---
        function startRandomizedQuiz() {
            startGame(masterQuestions, true);
        }

        function startSequentialQuiz() {
            startGame(masterQuestions, false);
        }

        function startGame(questions, shuffle = false) {
            currentQuestionIndex = 0;
            score = 0;
            isAnswerLocked = false;
            lastCorrectAnswerIndex = -1;

            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';
            void progressBar.offsetHeight;
            progressBar.style.transition = 'width 0.3s ease-in-out';

            currentQuizSet = questions.map(q => ({
                ...q,
                answers: q.answers.map(a => ({ ...a }))
            }));

            if (shuffle) {
                 shuffleArray(currentQuizSet);
            }
            
            // Uses the length of the incoming question set (55 for full quiz, 1 for your test)
            progressDisplay.textContent = `Question 1 / ${questions.length}`;

            showView('quiz');
            showQuestion();
            updateUI();
        }

        function updateUI() {
            scoreDisplay.innerHTML = `<span data-lucide="medal" class="w-4 h-4 mr-1 text-yellow-600 fill-yellow-400" aria-hidden="true"></span> Score: ${score}`;
            
            // This will use currentQuizSet.length after the fix in showQuestion()
            progressDisplay.textContent = `Question ${currentQuestionIndex + 1} / ${currentQuizSet.length}`;
            const percentage = currentQuizSet.length > 0 ? ((currentQuestionIndex + 1) / currentQuizSet.length) * 100 : 0;
            
            progressBar.style.width = `${percentage}%`;
            renderIcons();
        }

        function showQuestion() {
            feedbackMessage.classList.remove('show');

            if (currentQuestionIndex >= currentQuizSet.length) {
                showEndScreen();
                return;
            }

            isAnswerLocked = false;
            const currentQuestion = currentQuizSet[currentQuestionIndex];
            let shuffledAnswers = currentQuestion.answers;
            let currentCorrectIndex = -1;

            do {
                shuffleArray(shuffledAnswers);
                currentCorrectIndex = shuffledAnswers.findIndex(answer => answer.isCorrect);
            } while (currentQuestionIndex > 0 && lastCorrectAnswerIndex !== -1 && currentCorrectIndex === lastCorrectAnswerIndex);

            lastCorrectAnswerIndex = currentCorrectIndex;

            questionText.textContent = currentQuestion.question;
            categoryIcon.setAttribute('data-lucide', getCategoryIcon(currentQuestion.category));
            categoryName.textContent = getCategoryDisplayName(currentQuestion.category);

            // Uses the length of the current quiz set (e.g., 1 during review)
            progressDisplay.textContent = `Question ${currentQuestionIndex + 1} / ${currentQuizSet.length}`;
            
            // Uses the length of the current quiz set for percentage
            const percentage = currentQuizSet.length > 0 ? ((currentQuestionIndex + 1) / currentQuizSet.length) * 100 : 0;
            progressBar.style.width = `${percentage}%`;

            answerButtonsContainer.innerHTML = '';

            nextButton.classList.add('opacity-50', 'cursor-not-allowed');
            nextButton.disabled = true;
            nextButton.setAttribute('aria-disabled', 'true');

            shuffledAnswers.forEach((answer) => {
                const button = document.createElement('button');
                button.textContent = answer.text;
                button.classList.add(
                    'answer-button', 'w-full', 'py-2', 'px-4', 'text-left', 'bg-gray-100', 'text-gray-800', 'font-medium', 'text-sm',
                    'rounded-lg', 'border', 'border-gray-300', 'shadow-sm', 'hover:bg-gray-200'
                );
                button.onclick = () => selectAnswer(button, answer);
                answerButtonsContainer.appendChild(button);
            });
             renderIcons();
        }

        function selectAnswer(selectedButton, selectedAnswer) {
            if (isAnswerLocked) return;
            isAnswerLocked = true;

            const allButtons = answerButtonsContainer.querySelectorAll('button');
            let explanation = selectedAnswer.explanation;
            let feedbackType = 'incorrect';
            let milestoneMessage = "";

            const questionNumber = currentQuestionIndex + 1;
            
            // This is the milestone fix from before, which is still correct
            if (questionNumber === 14) milestoneMessage = "⭐ You're 25% Done! Keep it Up! ⭐"; // 14 is ~25% of 55
            else if (questionNumber === 28) milestoneMessage = "🎉 WOOHOO! Halfway There! 🎉"; // 28 is ~50% of 55
            else if (questionNumber === 41) milestoneMessage = "🚀 Almost Finished! 75% Complete! 🚀"; // 41 is ~75% of 55

            if (selectedAnswer.isCorrect) {
                score++;
                selectedButton.classList.add('correct');
                feedbackType = 'correct';
            } else {
                selectedButton.classList.add('incorrect');
                const originalQuestion = currentQuizSet[currentQuestionIndex];
                // Find the index *from the master list* to add to the incorrectlyAnsweredIndices
                const masterIndex = masterQuestions.findIndex(q => q.question === originalQuestion.question);
                if (masterIndex !== -1 && !incorrectlyAnsweredIndices.includes(masterIndex)) {
                    incorrectlyAnsweredIndices.push(masterIndex);
                }
                if(lastCorrectAnswerIndex >= 0 && lastCorrectAnswerIndex < allButtons.length) {
                    allButtons[lastCorrectAnswerIndex].classList.add('correct');
                }
            }

            showFeedback(explanation, feedbackType, milestoneMessage);

            allButtons.forEach(btn => btn.disabled = true);

            updateUI(); // updateUI will now use the correct 'currentQuizSet.length'

            nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
            nextButton.disabled = false;
            nextButton.setAttribute('aria-disabled', 'false');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function showEndScreen() {
             showView('end');

             const wrongCount = incorrectlyAnsweredIndices.length;
             wrongCountSpan.textContent = wrongCount;

             const isDisabled = wrongCount === 0;
             reviewButton.disabled = isDisabled;
             reviewButton.setAttribute('aria-disabled', isDisabled ? 'true' : 'false');

             // Uses the length of the current quiz set (e.g., 1 during review)
             finalScore.textContent = `You scored ${score} out of ${currentQuizSet.length}!`;

             const isNewHighScore = saveHighScore(score);
             const currentHighScore = getHighScore();
             
             // Only show high score logic if this was the main quiz, not a review session
             if (currentQuizSet.length === TOTAL_QUESTIONS) {
                 if (isNewHighScore && score > 0) {
                    highScoreDisplay.innerHTML = `🏆 <span class="text-amber-600 font-bold">New High Score: ${currentHighScore}!</span>`;
                 } else {
                    highScoreDisplay.textContent = `High Score: ${currentHighScore}`;
                    highScoreDisplay.classList.remove('text-amber-600', 'font-bold');
                 }
             } else {
                highScoreDisplay.textContent = ""; // Don't show high score on review
             }

             let message = '';
             let rank = 'Novice Tracker';
             let rankIconType = 'trophy';
             
             // Uses the length of the current quiz set for percentage
             const percentage = currentQuizSet.length > 0 ? (score / currentQuizSet.length) * 100 : 0;

            if (percentage === 100) {
                rank = "Master Guide"; rankIconType = "crown";
                message = "👑 Unbelievable! 100%! You are a Master Guide! You know your stuff inside and out!";
            } else if (percentage >= 90) {
                rank = "Hunter Safety Hero!"; rankIconType = "star";
                message = "⭐ Hunter Safety Hero! Outstanding score! You're clearly dedicated to safety and knowledge. Ready for the field!";
            } else if (percentage >= 75) {
                rank = "Skilled Scout"; rankIconType = "map";
                message = `🧭 Skilled Scout! Great job! You have a solid understanding. Review your ${wrongCount} mistake${wrongCount !== 1 ? 's' : ''} to reach Hero status!`;
            } else {
                rank = "Novice Tracker"; rankIconType = "feather";
                message = `🌱 Novice Tracker! Good start! Keep practicing and pay close attention to the explanations. Every hunter starts here! Review your ${wrongCount} mistake${wrongCount !== 1 ? 's' : ''}.`;
            }
            
             // Only add high score messages if this was the main quiz
             if (currentQuizSet.length === TOTAL_QUESTIONS) {
                 if (isNewHighScore && score > 0) {
                     message += " Plus, you set a new high score!";
                 } else if (score === currentHighScore && score > 0) {
                      message += " You matched the high score!";
                 } else if (score < currentHighScore && percentage < 100) {
                     message += ` Keep trying to beat the high score of ${currentHighScore}!`;
                 }
             } else if (percentage === 100) {
                message = "✅ All reviewed answers are now correct! Great job!";
             }

             rankTitle.textContent = `Your Rank: ${rank}`;
             rankIcon.setAttribute('data-lucide', rankIconType);
             finalMessage.textContent = message.trim();

             try {
                // Only confetti if it was the main quiz
                if (typeof confetti === 'function' && currentQuizSet.length === TOTAL_QUESTIONS && (percentage === 100 || (isNewHighScore && score > 0))) {
                    confetti({
                        particleCount: 150,
                        spread: 90,
                        origin: { y: 0.6 }
                    });
                }
             } catch (e) {
                 console.warn("Confetti library not available or failed:", e);
             }

             renderIcons();
        }

        // --- RESTART / NAVIGATION FUNCTIONS ---
        function goBackToLaunch() {
             feedbackMessage.classList.remove('show');
             incorrectlyAnsweredIndices = []; // Clear errors on returning home
             reviewButton.disabled = true;
             reviewButton.setAttribute('aria-disabled', 'true');
            showView('launch');
        }

        function reviewWrongAnswers() {
            if (incorrectlyAnsweredIndices.length === 0) {
                showFeedback("🥳 You got everything right! No mistakes to review.", 'correct');
                 setTimeout(() => { goBackToLaunch(); }, 2000);
                return;
            }
            const reviewQuestions = incorrectlyAnsweredIndices.map(index => masterQuestions[index]);
            incorrectlyAnsweredIndices = []; // Clear errors *before* starting the review
            startGame(reviewQuestions, false); // This will now start a game with the small set
        }

        // --- INITIALIZATION ---
        window.onload = () => {
             // ADDED: Clears the old high score when the page loads
             localStorage.removeItem(HIGH_SCORE_KEY);

             showView('launch');
        };
    </script>
</body>
</html>
