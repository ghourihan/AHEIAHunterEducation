<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunter Education Practice Quiz</title>
    <meta name="description" content="A free practice quiz for the AHEIA Hunter Education course. Study by topic or take a full randomized exam.">
    <meta name="google-site-verification" content="6Vs--1T4jNJNSn_4WfjlVCY9kqF-B2apx-T_6zm2y-c" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* Custom font and base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f1; /* Light Teal Background */
        }
        .container {
            max-width: 640px; /* Wider for desktop/tablet */
            width: 100%;     /* Ensure it shrinks on mobile */
            padding: 1rem;
        }
        /* Custom styles for engaging buttons */
        .answer-button {
            transition: all 0.15s ease-in-out;
            transform: scale(1);
        }
        .answer-button:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .correct {
            background-color: #10b981 !important; /* Emerald 500 */
            color: white !important;
            border-color: #059669 !important;
            animation: pulse-correct 0.5s 1;
        }
        .incorrect {
            background-color: #ef4444 !important; /* Red 500 */
            color: white !important;
            border-color: #dc2626 !important;
            animation: shake-incorrect 0.5s 1;
        }
        @keyframes pulse-correct {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        @keyframes shake-incorrect {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }

        }
        /* Style for the feedback message box (modal replacement) */
        #feedback-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out, visibility 0.3s;
        }
        #feedback-message.show {
            transform: translate(-50%, -50%) scale(1);
            visibility: visible;
            opacity: 1;
        }
        /* Progress Bar Styles */
        #progress-bar-container {
            background-color: #cbd5e1;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
            width: 100%;
            margin-top: 4px;
        }
        #progress-bar {
            background-color: #22c55e;
            height: 100%;
            width: 0%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        /* Style for centered milestone message */
        .milestone-text {
            text-align: center;
            font-weight: bold;
            margin-top: 0.5rem;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        /* Ensure feedback text wraps */
        #feedback-text {
            overflow-wrap: break-word;
            word-wrap: break-word; /* legacy */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="quiz-app" class="container bg-white shadow-2xl rounded-xl border border-gray-100">

        <div id="launch-screen" class="p-8 text-center">
            <span data-lucide="shield" class="w-16 h-16 inline-block text-green-700 mb-4" aria-hidden="true"></span>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome, Future Hunter!</h1>
            <p class="text-md text-gray-600 mb-8">Choose your practice mode below to begin your Hunter Education review.</p>

            <div class="space-y-4">
                <button onclick="startRandomizedQuiz()" class="w-full py-3 bg-amber-600 text-white font-bold rounded-lg shadow-lg hover:bg-amber-700 transition-colors flex items-center justify-center">
                    <span data-lucide="shuffle" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                    Challenge Mode (Random Questions)
                </button>
                <button onclick="startSequentialQuiz()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-lg shadow-lg hover:bg-emerald-700 transition-colors flex items-center justify-center">
                    <span data-lucide="list-ordered" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                    Study Mode (Questions in Order)
                </button>
            </div>

            <hr class="my-6 border-gray-300">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Practice by Topic</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button onclick="startCategoryQuiz('Safety')" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center text-sm">
                    <span data-lucide="shield" class="w-4 h-4 mr-2" aria-hidden="true"></span>
                    Safety
                </button>
                <button onclick="startCategoryQuiz('Ethics')" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center text-sm">
                    <span data-lucide="gavel" class="w-4 h-4 mr-2" aria-hidden="true"></span>
                    Ethics & Legal
                </button>
                <button onclick="startCategoryQuiz('Survival')" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center text-sm">
                    <span data-lucide="tent" class="w-4 h-4 mr-2" aria-hidden="true"></span>
                    Survival & First Aid
                </button>
                <button onclick="startCategoryQuiz('Wildlife ID')" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center text-sm">
                    <span data-lucide="paw-print" class="w-4 h-4 mr-2" aria-hidden="true"></span>
                    Wildlife ID
                </button>
                <button onclick="startCategoryQuiz('Conservation')" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center text-sm sm:col-span-2">
                    <span data-lucide="tree-pine" class="w-4 h-4 mr-2" aria-hidden="true"></span>
                    Conservation
                </button>
            </div>

            <p id="tip-display" class="text-sm text-gray-500 mt-8 italic"></p>
        </div>

        <div id="quiz-view" class="hidden">
            <header class="p-4 bg-green-700 text-white rounded-t-xl text-center">
                <div class="flex items-center justify-center mb-1">
                    <span data-lucide="shield-check" class="w-7 h-7 mr-2" aria-hidden="true"></span>
                    <h1 class="text-2xl font-bold tracking-tight">Hunter Education Practice Quiz</h1>
                </div>
                <p class="text-xs opacity-90">AHEIA Hunter Education</p>
            </header>

            <div class="flex justify-between items-center p-3 bg-green-50 rounded-b-lg border-b border-green-200">
                <span id="score-display" class="text-md font-semibold text-green-800 flex items-center" aria-live="polite">
                    <span data-lucide="medal" class="w-4 h-4 mr-1 text-yellow-600 fill-yellow-400" aria-hidden="true"></span> Score: 0
                </span>
                 <div class="flex-grow ml-4">
                    <span id="progress-display" class="text-xs font-medium text-gray-600 block text-right">
                        Question 1 / 137
                    </span>
                    <div id="progress-bar-container">
                        <div id="progress-bar"></div>
                    </div>
                </div>
            </div>

             <main id="game-container" class="p-3" aria-live="polite">
                 <div class="flex items-center mb-2 text-green-700">
                    <span id="category-icon" data-lucide="shield" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                    <span id="category-name" class="text-md font-semibold">Safety</span>
                </div>
                 <h2 id="question-text" class="text-lg font-bold mb-3 text-gray-800 leading-relaxed">
                    Loading question...
                </h2>
                 <div id="answer-buttons" class="space-y-2">
                    </div>
                 <button id="next-button"
                        class="mt-3 w-full py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors opacity-50 cursor-not-allowed"
                        onclick="nextQuestion()"
                        disabled
                        aria-disabled="true">
                    Next Question
                    <span data-lucide="arrow-right" class="w-5 h-5 inline ml-2" aria-hidden="true"></span>
                </button>

                 <button id="return-launch-quiz"
                        class="mt-2 w-full py-1.5 bg-green-700 text-white text-sm font-medium rounded-lg shadow-md hover:bg-green-800 transition-colors flex items-center justify-center"
                        onclick="goBackToLaunch()">
                    <span data-lucide="home" class="w-4 h-4 mr-1" aria-hidden="true"></span>
                    Return to Launch Screen
                </button>
            </main>

            <div id="end-screen" class="hidden p-8 text-center">
                <span id="rank-icon" data-lucide="trophy" class="w-16 h-16 mx-auto mb-4 text-yellow-500 fill-yellow-300" aria-hidden="true"></span>
                <h3 id="rank-title" class="text-2xl font-extrabold text-green-700 mb-3">Quiz Complete!</h3>
                <p id="final-score" class="text-3xl font-bold mb-2 text-gray-800">You scored 0/137!</p>
                <p id="high-score-display" class="text-md font-semibold text-gray-700 mb-4"></p>
                <p id="final-message" class="text-lg mb-8 text-gray-600"></p>
                <div class="space-y-4">
                    <button id="review-button" onclick="reviewWrongAnswers()"
                            class="w-full py-3 bg-yellow-600 text-white font-bold rounded-lg shadow-lg hover:bg-yellow-700 transition-colors flex items-center justify-center disabled:opacity-50"
                            disabled>
                        <span data-lucide="book-open-check" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                        Review Wrong Answers (<span id="wrong-count">0</span>)
                    </button>
                    <button onclick="goBackToLaunch()"
                            class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                        <span data-lucide="home" class="w-5 h-5 mr-2" aria-hidden="true"></span>
                        Return to Launch Screen
                    </button>

                    <hr class="my-4 border-gray-300">
                    <div>
                      <a href="https://www.buymeacoffee.com/ghourihan" target="_blank">
                        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-orange.png" alt="Buy Me A Coffee" 
                             style="height: 60px !important; width: 217px !important; margin: 0 auto;">
                      </a>
                    </div>
                    </div>
            </div>
        </div>
    </div>

    <div id="feedback-message" role="alert" tabindex="-1" class="p-4 rounded-xl shadow-2xl transition-all border-4 border-white backdrop-blur-sm" aria-live="polite">
        <div class="flex items-center justify-center">
            <span id="feedback-icon" class="text-4xl mr-3" aria-hidden="true"></span>
            <span id="feedback-text" class="text-xl font-bold text-white"></span>
        </div>
    </div>

    <script>
        // --- QUIZ DATA ---
        let masterQuestions = []; // This will be loaded from questions.json
        let TOTAL_QUESTIONS = 0; // Will be set after loading

        // --- GAME STATE ---
        let currentQuestionIndex = 0;
        let score = 0;
        let isAnswerLocked = false;
        let incorrectlyAnsweredIndices = [];
        let currentQuizSet;
        let lastCorrectAnswerIndex = -1;
        const HIGH_SCORE_KEY = 'hunterEdQuizHighScore';

        // --- Feedback Message Arrays ---
        const correctMessages = [
            "‚úÖ Nailed it!", "‚úÖ Awesome!", "‚úÖ You got it!", "‚úÖ Exactly right!", "‚úÖ Great job!",
        ];
        const incorrectMessages = [
            "‚ùå Not quite!", "‚ùå Close, but try this:", "‚ùå That wasn't it. Here's the scoop:",
            "‚ùå Good try! The correct answer is:", "‚ùå Oops! Remember this:",
        ];

         // --- Hunting Tips Array ---
        const tips = [
            "Always point your firearm in a safe direction.", "Treat every firearm as if it were loaded.",
            "Be sure of your target and what's beyond it.", "Keep your finger off the trigger until ready to shoot.",
            "Always ask for permission before hunting on private land.", "Respect landowners and their property.",
            "Make every effort to recover harvested game.", "Know your firearm and ammunition.",
            "Practice marksmanship for clean, ethical shots.", "Wear blaze orange for visibility.",
            "Clean, Drain, and Dry your boat and gear to prevent invasive species.",
            "Report poachers using the Report-A-Poacher line.",
            "Always carry a map, compass, and know how to use them.",
            "Pack essential survival gear, even for short trips.",
            "Tell someone your hunting plan and when you expect to return."
        ];

        // --- DOM REFERENCES ---
        const questionText = document.getElementById('question-text');
        const answerButtonsContainer = document.getElementById('answer-buttons');
        const nextButton = document.getElementById('next-button');
        const scoreDisplay = document.getElementById('score-display');
        const progressDisplay = document.getElementById('progress-display');
        const gameContainer = document.getElementById('game-container');
        const endScreen = document.getElementById('end-screen');
        const finalScore = document.getElementById('final-score');
        const finalMessage = document.getElementById('final-message');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackText = document.getElementById('feedback-text');
        const feedbackIcon = document.getElementById('feedback-icon');
        const reviewButton = document.getElementById('review-button');
        const wrongCountSpan = document.getElementById('wrong-count');
        const categoryIcon = document.getElementById('category-icon');
        const categoryName = document.getElementById('category-name');
        const rankIcon = document.getElementById('rank-icon');
        const rankTitle = document.getElementById('rank-title');
        const launchScreen = document.getElementById('launch-screen');
        const quizView = document.getElementById('quiz-view');
        const progressBar = document.getElementById('progress-bar');
        const highScoreDisplay = document.getElementById('high-score-display');
        const tipDisplay = document.getElementById('tip-display');

        // --- HELPER FUNCTIONS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderIcons() {
            lucide.createIcons();
        }

        function getCategoryIcon(category) {
            switch(category) {
                case "Safety": return "shield";
                case "Ethics": return "gavel";
                case "Survival": return "tent";
                case "Wildlife ID": return "paw-print";
                case "Conservation": return "tree-pine";
                default: return "help-circle";
            }
        }

        function getCategoryDisplayName(category) {
            switch(category) {
                case "Safety": return "Firearm & Archery Safety";
                case "Ethics": return "Ethics & Legal Responsibility";
                case "Survival": return "Survival & First Aid";
                case "Wildlife ID": return "Wildlife Identification";
                case "Conservation": return "Conservation & Management";
                default: return "Unknown Topic";
            }
        }

        function showFeedback(explanation, type, milestoneMsg = "") {
            let feedbackPrefix = "";

            if (type === 'correct') {
                feedbackPrefix = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                feedbackMessage.style.backgroundColor = 'rgba(16, 185, 129, 0.9)';
                feedbackMessage.style.borderColor = 'white';
                feedbackIcon.innerHTML = 'üéâ';
            } else { // incorrect
                feedbackPrefix = incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)];
                feedbackMessage.style.backgroundColor = 'rgba(239, 68, 68, 0.9)';
                feedbackMessage.style.borderColor = 'white';
                feedbackIcon.innerHTML = '‚ùå';
            }

            let htmlContent = `${feedbackPrefix} ${explanation}`.trim();
            if (milestoneMsg) {
                htmlContent += `<br><div class="milestone-text">${milestoneMsg}</div>`;
            }

            feedbackText.innerHTML = htmlContent;
            feedbackMessage.classList.add('show');
            
            // --- ACCESSIBILITY IMPROVEMENT: Focus the modal ---
            feedbackMessage.focus();
        }

        // --- UPDATED High Score Functions (Simplified saveHighScore) ---
        function getHighScore() {
            return parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0');
        }

        function saveHighScore(newScore) {
            const currentHighScore = getHighScore();
            if (newScore > currentHighScore) {
                localStorage.setItem(HIGH_SCORE_KEY, newScore.toString());
                return true;
            }
            return false;
        }

        // --- View Management ---
        function showView(viewName) {
            launchScreen.classList.add('hidden');
            quizView.classList.add('hidden');
            gameContainer.classList.add('hidden');
            endScreen.classList.add('hidden');

            if (viewName === 'launch') {
                launchScreen.classList.remove('hidden');
                // Only set tip if masterQuestions is loaded
                if (masterQuestions.length > 0) {
                    const randomTip = tips[Math.floor(Math.random() * tips.length)];
                    tipDisplay.textContent = `üí° Tip: ${randomTip}`;
                }
            } else if (viewName === 'quiz') {
                quizView.classList.remove('hidden');
                gameContainer.classList.remove('hidden');
            } else if (viewName === 'end') {
                 quizView.classList.remove('hidden');
                 endScreen.classList.remove('hidden');
            }
             renderIcons();
        }

        // --- GAME LOGIC ---
        function startRandomizedQuiz() {
            startGame(masterQuestions, true);
        }

        function startSequentialQuiz() {
            startGame(masterQuestions, false);
        }

        // ===== NEW FUNCTION =====
        function startCategoryQuiz(category) {
            const categoryQuestions = masterQuestions.filter(q => q.category === category);
            // We pass 'true' to always shuffle the category quiz
            startGame(categoryQuestions, true); 
        }
        // ===== END OF NEW FUNCTION =====

        function startGame(questions, shuffle = false) {
            currentQuestionIndex = 0;
            score = 0;
            isAnswerLocked = false;
            lastCorrectAnswerIndex = -1;

            progressBar.style.transition = 'none';
            progressBar.style.width = '0%';
            void progressBar.offsetHeight;
            progressBar.style.transition = 'width 0.3s ease-in-out';

            currentQuizSet = questions.map(q => ({
                ...q,
                answers: q.answers.map(a => ({ ...a }))
            }));

            if (shuffle) {
                 shuffleArray(currentQuizSet);
            }
            
            // Uses the length of the incoming question set (137 for full quiz, or smaller for review)
            progressDisplay.textContent = `Question 1 / ${questions.length}`;

            showView('quiz');
            showQuestion();
            updateUI();
        }

        function updateUI() {
            scoreDisplay.innerHTML = `<span data-lucide="medal" class="w-4 h-4 mr-1 text-yellow-600 fill-yellow-400" aria-hidden="true"></span> Score: ${score}`;
            
            // This will use currentQuizSet.length
            progressDisplay.textContent = `Question ${currentQuestionIndex + 1} / ${currentQuizSet.length}`;
            const percentage = currentQuizSet.length > 0 ? ((currentQuestionIndex + 1) / currentQuizSet.length) * 100 : 0;
            
            progressBar.style.width = `${percentage}%`;
            renderIcons();
        }

        function showQuestion() {
            feedbackMessage.classList.remove('show');

            if (currentQuestionIndex >= currentQuizSet.length) {
                showEndScreen();
                return;
            }

            isAnswerLocked = false;
            const currentQuestion = currentQuizSet[currentQuestionIndex];
            let shuffledAnswers = currentQuestion.answers;
            let currentCorrectIndex = -1;

            do {
                shuffleArray(shuffledAnswers);
                currentCorrectIndex = shuffledAnswers.findIndex(answer => answer.isCorrect);
            } while (currentQuestionIndex > 0 && lastCorrectAnswerIndex !== -1 && currentCorrectIndex === lastCorrectAnswerIndex);

            lastCorrectAnswerIndex = currentCorrectIndex;

            questionText.textContent = currentQuestion.question;
            categoryIcon.setAttribute('data-lucide', getCategoryIcon(currentQuestion.category));
            categoryName.textContent = getCategoryDisplayName(currentQuestion.category);

            // Uses the length of the current quiz set
            progressDisplay.textContent = `Question ${currentQuestionIndex + 1} / ${currentQuizSet.length}`;
            
            // Uses the length of the current quiz set for percentage
            const percentage = currentQuizSet.length > 0 ? ((currentQuestionIndex + 1) / currentQuizSet.length) * 100 : 0;
            progressBar.style.width = `${percentage}%`;

            answerButtonsContainer.innerHTML = '';

            nextButton.classList.add('opacity-50', 'cursor-not-allowed');
            nextButton.disabled = true;
            nextButton.setAttribute('aria-disabled', 'true');

            shuffledAnswers.forEach((answer) => {
                const button = document.createElement('button');
                button.textContent = answer.text;
                button.classList.add(
                    'answer-button', 'w-full', 'py-2', 'px-4', 'text-left', 'bg-gray-100', 'text-gray-800', 'font-medium', 'text-sm',
                    'rounded-lg', 'border', 'border-gray-300', 'shadow-sm', 'hover:bg-gray-200'
                );
                button.onclick = () => selectAnswer(button, answer);
                answerButtonsContainer.appendChild(button);
            });
             renderIcons();
        }

        function selectAnswer(selectedButton, selectedAnswer) {
            if (isAnswerLocked) return;
            isAnswerLocked = true;

            const allButtons = answerButtonsContainer.querySelectorAll('button');
            let explanation = selectedAnswer.explanation;
            let feedbackType = 'incorrect';
            let milestoneMessage = "";

            const questionNumber = currentQuestionIndex + 1;
            
            // Check milestones against the *current* quiz set length
            const twentyFivePercent = Math.floor(currentQuizSet.length * 0.25);
            const fiftyPercent = Math.floor(currentQuizSet.length * 0.5);
            const seventyFivePercent = Math.floor(currentQuizSet.length * 0.75);

            if (questionNumber === twentyFivePercent && twentyFivePercent > 0) milestoneMessage = "‚≠ê You're 25% Done! Keep it Up! ‚≠ê";
            else if (questionNumber === fiftyPercent && fiftyPercent > 0) milestoneMessage = "üéâ WOOHOO! Halfway There! üéâ";
            else if (questionNumber === seventyFivePercent && seventyFivePercent > 0) milestoneMessage = "üöÄ Almost Finished! 75% Complete! üöÄ";

            if (selectedAnswer.isCorrect) {
                score++;
                selectedButton.classList.add('correct');
                feedbackType = 'correct';
            } else {
                selectedButton.classList.add('incorrect');
                const originalQuestion = currentQuizSet[currentQuestionIndex];
                // Find the index *from the master list* to add to the incorrectlyAnsweredIndices
                const masterIndex = masterQuestions.findIndex(q => q.question === originalQuestion.question);
                if (masterIndex !== -1 && !incorrectlyAnsweredIndices.includes(masterIndex)) {
                    incorrectlyAnsweredIndices.push(masterIndex);
                }
                if(lastCorrectAnswerIndex >= 0 && lastCorrectAnswerIndex < allButtons.length) {
                    allButtons[lastCorrectAnswerIndex].classList.add('correct');
                }
            }

            showFeedback(explanation, feedbackType, milestoneMessage);

            allButtons.forEach(btn => btn.disabled = true);

            updateUI(); // updateUI will now use the correct 'currentQuizSet.length'

            nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
            nextButton.disabled = false;
            nextButton.setAttribute('aria-disabled', 'false');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function showEndScreen() {
             showView('end');

             const wrongCount = incorrectlyAnsweredIndices.length;
             wrongCountSpan.textContent = wrongCount;

             const isDisabled = wrongCount === 0;
             reviewButton.disabled = isDisabled;
             reviewButton.setAttribute('aria-disabled', isDisabled ? 'true' : 'false');

             // Uses the length of the current quiz set
             finalScore.textContent = `You scored ${score} out of ${currentQuizSet.length}!`;

             const isNewHighScore = saveHighScore(score);
             const currentHighScore = getHighScore();
             
             // Only show high score logic if this was the main quiz (TOTAL_QUESTIONS), 
             // not a review session or category quiz
             if (currentQuizSet.length === TOTAL_QUESTIONS) {
                 if (isNewHighScore && score > 0) {
                    highScoreDisplay.innerHTML = `üèÜ <span class="text-amber-600 font-bold">New High Score: ${currentHighScore}!</span>`;
                 } else {
                    highScoreDisplay.textContent = `High Score: ${currentHighScore}`;
                    highScoreDisplay.classList.remove('text-amber-600', 'font-bold');
                 }
             } else {
                highScoreDisplay.textContent = ""; // Don't show high score on review or category quiz
             }

             let message = '';
             let rank = 'Novice Tracker';
             let rankIconType = 'trophy';
             
             // Uses the length of the current quiz set for percentage
             const percentage = currentQuizSet.length > 0 ? (score / currentQuizSet.length) * 100 : 0;

            if (percentage === 100) {
                rank = "Master Guide"; rankIconType = "crown";
                message = "üëë Unbelievable! 100%! You are a Master Guide! You know your stuff inside and out!";
            } else if (percentage >= 90) {
                rank = "Hunter Safety Hero!"; rankIconType = "star";
                message = "‚≠ê Hunter Safety Hero! Outstanding score! You're clearly dedicated to safety and knowledge. Ready for the field!";
            } else if (percentage >= 75) {
                rank = "Skilled Scout"; rankIconType = "map";
                message = `üß≠ Skilled Scout! Great job! You have a solid understanding. Review your ${wrongCount} mistake${wrongCount !== 1 ? 's' : ''} to reach Hero status!`;
            } else {
                rank = "Novice Tracker"; rankIconType = "feather";
                message = `üå± Novice Tracker! Good start! Keep practicing and pay close attention to the explanations. Every hunter starts here! Review your ${wrongCount} mistake${wrongCount !== 1 ? 's' : ''}.`;
            }
            
             // Only add high score messages if this was the main quiz
             if (currentQuizSet.length === TOTAL_QUESTIONS) {
                 if (isNewHighScore && score > 0) {
                     message += " Plus, you set a new high score!";
                 } else if (score === currentHighScore && score > 0) {
                      message += " You matched the high score!";
                 } else if (score < currentHighScore && percentage < 100) {
                     message += ` Keep trying to beat the high score of ${currentHighScore}!`;
                 }
             } else if (percentage === 100 && currentQuizSet.length !== TOTAL_QUESTIONS) {
                 // This message now applies to review quizzes *and* category quizzes
                message = "‚úÖ Perfect score on this section! Great job!";
             }

             rankTitle.textContent = `Your Rank: ${rank}`;
             rankIcon.setAttribute('data-lucide', rankIconType);
             finalMessage.textContent = message.trim();

             try {
                // Only confetti on 100% or a new high score on the *main* quiz
                if (typeof confetti === 'function' && currentQuizSet.length === TOTAL_QUESTIONS && (percentage === 100 || (isNewHighScore && score > 0))) {
                    confetti({
                        particleCount: 150,
                        spread: 90,
                        origin: { y: 0.6 }
                    });
                }
             } catch (e) {
                 console.warn("Confetti library not available or failed:", e);
             }

             renderIcons();
        }

        // --- RESTART / NAVIGATION FUNCTIONS ---
        function goBackToLaunch() {
             feedbackMessage.classList.remove('show');
             incorrectlyAnsweredIndices = []; // Clear errors on returning home
             reviewButton.disabled = true;
             reviewButton.setAttribute('aria-disabled', 'true');
            showView('launch');
        }

        function reviewWrongAnswers() {
            if (incorrectlyAnsweredIndices.length === 0) {
                showFeedback("ü•≥ You got everything right! No mistakes to review.", 'correct');
                 setTimeout(() => { goBackToLaunch(); }, 2000);
                return;
            }
            const reviewQuestions = incorrectlyAnsweredIndices.map(index => masterQuestions[index]);
            incorrectlyAnsweredIndices = []; // Clear errors *before* starting the review
            startGame(reviewQuestions, false); // This will now start a game with the small set
        }

        // --- INITIALIZATION ---
        window.onload = async () => {
            try {
                // Show a loading state on the launch screen
                const allButtons = document.getElementById('launch-screen').querySelectorAll('button');
                allButtons.forEach(btn => btn.disabled = true);
                tipDisplay.textContent = "Loading questions, please wait...";

                const response = await fetch('questions.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                masterQuestions = await response.json();
                TOTAL_QUESTIONS = masterQuestions.length;

                // Re-enable buttons and show normal view
                allButtons.forEach(btn => btn.disabled = false);
                showView('launch'); // This will now set the random tip

            } catch (error) {
                console.error("Failed to load questions:", error);
                // Display a permanent error on the page
                const launchScreen = document.getElementById('launch-screen');
                launchScreen.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                        <h1 class="text-2xl font-bold text-red-800 mb-2">Error Loading Quiz</h1>
                        <p class="text-md mb-4">Could not load quiz questions from 'questions.json'.</p>
                        <p class="text-sm font-medium">Please make sure the 'questions.json' file is in the same directory as this HTML file. You may need to refresh the page.</p>
                    </div>
                `;
            }
        };
    </script>
</body>
</html>
